syntax = "proto3";

package mentor.client.chat;

import "google/protobuf/empty.proto";
import "mentor/types/bot.proto";
import "mentor/types/billing.proto";
import "mentor/types/chat.proto";
import "mentor/types/common.proto";
import "mentor/types/identity.proto";

// Сервис Чата (Клиентский API).
service ChatService {
  // --- Управление Списком Ботов (Контакты) ---

  // Получить список ботов, с которыми есть активные диалоги (или закрепленные).
  // Возвращает список ботов с метаданными (закреплен, порядок, последнее сообщение).
  // Используется для отображения левого меню контактов.
  rpc ListContactBots(google.protobuf.Empty) returns (ListContactBotsResponse);

  // Закрепить бота в топе списка.
  // Возвращает обновленный список ID закрепленных ботов.
  rpc PinBot(mentor.types.bot.Bot.Id) returns (mentor.types.bot.Bot.Ids);

  // Открепить бота.
  // Возвращает обновленный список ID закрепленных ботов.
  rpc UnpinBot(mentor.types.bot.Bot.Id) returns (mentor.types.bot.Bot.Ids);

  // Изменить порядок закрепленных ботов.
  // Принимает новый порядок ID. Возвращает подтвержденный порядок.
  rpc ReorderPinnedBots(mentor.types.bot.Bot.Ids) returns (mentor.types.bot.Bot.Ids);

  // --- Управление Диалогами (Тредами) ---

  // Получить список диалогов в конкретном боте (с пагинацией).
  // В запросе (mentor.types.Cursor) нужно передать bot_id в фильтрах, если это предусмотрено,
  // или использовать отдельное поле, если Cursor не подходит.
  // В текущей реализации mentor.types.Cursor содержит filters map<string, string>.
  // Ожидается bot_id в фильтре курсора.
  rpc ListChats(mentor.types.Cursor) returns (mentor.types.chat.ChatThread.List);

  // Обновить название чата (пользовательское).
  rpc UpdateChatTitle(UpdateChatTitleRequest) returns (mentor.types.chat.ChatThread);

  // Обновить настройки чата (режим ответа, thinking mode).
  rpc UpdateChatConfiguration(UpdateChatConfigurationRequest) returns (mentor.types.chat.ChatThread);

  // Удалить диалог.
  rpc DeleteChat(mentor.types.chat.ChatThread.Id) returns (google.protobuf.Empty);

  // --- Сообщения ---

  // Получить историю сообщений (с пагинацией и поддержкой фильтра по избранным).
  rpc GetHistory(GetHistoryRequest) returns (mentor.types.chat.Message.List);

  // Отправить сообщение.
  rpc SendMessage(SendMessageRequest) returns (mentor.types.chat.Message);
  
  // Добавить сообщение в избранное.
  rpc AddToFavorites(mentor.types.chat.Message.Id) returns (google.protobuf.Empty);
  
  // Удалить сообщение из избранного.
  rpc RemoveFromFavorites(mentor.types.chat.Message.Id) returns (google.protobuf.Empty);

  // --- Real-time ---
  
  // Подписка на события (Тайпинг, Новые сообщения).
  // Глобальный стрим для текущего пользователя (все боты, все чаты).
  rpc SubscribeToEvents(google.protobuf.Empty) returns (stream mentor.types.chat.ChatEvent);
}

// --- Запросы и Ответы ---

message ListContactBotsResponse {
  // Элемент списка контактов.
  message Contact {
    mentor.types.bot.Bot bot = 1;
    mentor.types.billing.BotTariffPlan plan = 2; // Текущий тарифный план.
    optional mentor.types.billing.BotSubscription subscription = 3; // Активная подписка.
    mentor.types.identity.PublicUserProfile creator = 4; // Автор бота.
    repeated mentor.types.chat.ChatThread chat_threads = 5; // Список чатов с пользователем и ботом.
  }
  repeated Contact contacts = 1;

  // Текущий порядок закрепленных ботов (список ID).
  // Используется для сортировки на клиенте.
  mentor.types.bot.Bot.Ids pin_order_bot_ids = 2;
}

message UpdateChatTitleRequest {
  uint32 thread_id = 1;
  string title = 2; // Новое название (если пустое не меняем).
}

message UpdateChatConfigurationRequest {
  uint32 thread_id = 1;
  mentor.types.chat.ChatThread.Configuration configuration = 2;
}

message GetHistoryRequest {
  mentor.types.Cursor cursor = 1;
  
  // Фильтр: искать только избранные сообщения.
  bool only_favorites = 2;
}

message SendMessageRequest {
  uint32 thread_id = 1;
  
  oneof content {
    string text = 2;      // Текстовое сообщение.
    bytes audio_data = 3; // Голосовое сообщение (raw bytes / encoded).
  }
}
