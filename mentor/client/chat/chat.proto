syntax = "proto3";

package mentor.client.chat;

import "mentor/types/chat.proto";
import "mentor/types/common.proto";

// Сервис Чата (Клиентский API).
service ChatService {
  // --- Управление Чатами (Сессиями) ---

  // Получить список чатов (с пагинацией и фильтрами).
  rpc ListChats(ListChatsRequest) returns (ListChatsResponse);

  // Обновить настройки чата (название, режим ответа).
  rpc UpdateChatThread(UpdateChatThreadRequest) returns (mentor.types.chat.ChatThread);

  // Удалить чат (Soft delete или полная очистка).
  rpc DeleteChatThread(DeleteChatThreadRequest) returns (DeleteChatThreadResponse);
  
  // Архивация / Разархивация чата.
  rpc ArchiveChat(ArchiveChatRequest) returns (mentor.types.chat.ChatThread);

  // Закрепление / Открепление чата.
  rpc PinChat(PinChatRequest) returns (mentor.types.chat.ChatThread);

  // Изменение порядка закрепленных чатов (Drag & Drop).
  rpc ReorderPinnedChats(ReorderPinnedChatsRequest) returns (ListChatsResponse);

  // --- Сообщения ---

  // Получить историю сообщений чата.
  rpc GetHistory(GetHistoryRequest) returns (GetHistoryResponse);

  // Отправить сообщение боту.
  rpc SendMessage(SendMessageRequest) returns (mentor.types.chat.Message);

  // Добавить/Убрать сообщение из избранного.
  rpc ToggleMessageFavorite(ToggleMessageFavoriteRequest) returns (ToggleMessageFavoriteResponse);

  // --- Real-time ---

  // Подписка на события чата (Тайпинг, Новые сообщения, Ошибки).
  rpc SubscribeToEvents(SubscribeToEventsRequest) returns (stream mentor.types.chat.ChatEvent);
}

// --- Запросы и Ответы ---

message ListChatsRequest {
  mentor.types.PageRequest pagination = 1;

  // Фильтр по ID бота (опционально).
  uint32 bot_id = 2; 
  
  // Только закрепленные.
  bool only_pinned = 3;

  // Статус архивации (false = активные, true = архивные).
  // Если не указано (null), может возвращать все (зависит от логики, но обычно разделяют).
  bool is_archived = 4; 
}

message ListChatsResponse {
  repeated mentor.types.chat.ChatThread threads = 1;
  mentor.types.PageResponse pagination = 2;
}

message UpdateChatThreadRequest {
  uint32 thread_id = 1;
  
  // Поля для обновления (если указаны).
  string title = 2; // Переименовать.
  mentor.types.chat.ChatMode response_mode = 3; // Сменить режим (Текст/Голос).
  bool sinking_mode_enabled = 4; // Включить/Выключить Sinking Mode.
}

message DeleteChatThreadRequest {
  uint32 thread_id = 1;
}

message DeleteChatThreadResponse {
  bool success = 1;
}

message ArchiveChatRequest {
  uint32 thread_id = 1;
  bool archived = 2; // true = в архив, false = вернуть.
}

message PinChatRequest {
  uint32 thread_id = 1;
  bool pinned = 2; // true = закрепить, false = открепить.
}

message ReorderPinnedChatsRequest {
  repeated uint32 thread_ids = 1; // Новый порядок ID.
}

message GetHistoryRequest {
  uint32 thread_id = 1;
  mentor.types.PageRequest pagination = 2;
  
  // Фильтр: только избранные.
  bool only_favorites = 3;
}

message GetHistoryResponse {
  repeated mentor.types.chat.Message messages = 1;
  mentor.types.PageResponse pagination = 2;
}

message SendMessageRequest {
  uint32 thread_id = 1;
  
  // Контент сообщения (oneof).
  // Упрощенная структура для отправки (клиент может слать текст или ссылку на медиа).
  oneof content {
    string text = 2;
    // Для отправки файлов, клиент сначала грузит их в S3 (через отдельный UploadService),
    // а сюда присылает URL.
    string audio_url = 3; 
    string image_url = 4;
    string file_url = 5;
  }
  
  // Локальный ID для идемпотентности (опционально).
  string local_id = 6; 
}

message ToggleMessageFavoriteRequest {
  string message_id = 1;
}

message ToggleMessageFavoriteResponse {
  bool is_favorite = 1; // Новое состояние.
}

message SubscribeToEventsRequest {
  uint32 thread_id = 1;
}
