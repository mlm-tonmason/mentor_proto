syntax = "proto3";

package mentor.types.chat;

import "google/protobuf/timestamp.proto";

// Поток Чата (Диалог).
// Один бот может иметь несколько диалогов с одним пользователем.
message ChatThread {
  message Id {
    uint32 id = 1;
  }
  message List {
    repeated ChatThread items = 1;
  }
  message Configuration {
    // Режим ответа бота в чате.
    message ChatMode {
      enum Id {
        UNSPECIFIED = 0; // Не указан
        TEXT = 1;        // Отвечать текстом (по умолчанию)
        VOICE = 2;       // Отвечать голосом (Voice)
      }
    }
    ChatMode.Id response_mode = 1;
    bool sinking_mode_enabled = 2; // Режим "Думать дольше" (Sinking Mode) для более качественных ответов.
  }
  
  uint32 id = 1; // Уникальный ID Чата.
  uint32 bot_id = 2; // ID бота, с которым идет диалог.
  uint32 distributor_id = 3; // ID пользователя (дистрибьютора), владеющего чатом.
  string title = 4; // Название чата (редактируемое пользователем).
  Configuration configuration = 5; // Настройки чата (режим ответа и т.д.).
  Message last_message = 6; // Последнее сообщение (для превью в списке).
}

// Сообщение в чате.
message Message {
  message Id {
    uint64 id = 1;
  }
  message List {
    repeated Message items = 1;
  }
  message Role {
    // Роль автора сообщения.
    enum Id {
      UNSPECIFIED = 0; // Не указана
      USER = 1;        // Пользователь
      BOT = 2;         // Бот (Ассистент)
      SYSTEM = 3;      // Система (уведомления)
    }
  }
  
  // Основной контент сообщения.
  message Content {
    message AudioContent {
      string url = 1;            // Ссылка на аудиофайл (CDN / S3).
      string transcription = 2;  // Текст расшифровки (Speech-to-Text).
      int32 duration_seconds = 3; // Длительность аудио в секундах.
      string mime_type = 4;      // MIME type, например "audio/ogg".
    }
    oneof kind {
      string text = 1;       // Простой текст / Markdown.
      AudioContent audio = 2; // Голосовое сообщение / Аудио.
    }
  }

  uint64 id = 1; // Уникальный ID Сообщения.
  uint32 thread_id = 2; // ID чата, к которому относится сообщение.
  Role.Id role = 3; // Кто отправил сообщение.
  Content content = 4; // Содержимое.
  bool is_favorite = 5; // Добавлено ли сообщение в избранное.
  google.protobuf.Timestamp created_at = 6; // Время создания.
}


// Событие в реальном времени (Server -> Client Stream).
message ChatEvent {
  // Индикатор активности бота.
  message TypingIndicator {
    enum Activity {
      UNSPECIFIED = 0;
      TYPING = 1;          // Печатает сообщение...
      RECORDING_VOICE = 2; // Записывает голосовое...
    }
    Activity activity = 1;
  }

  // Ошибка в стриме.
  message Error {
    string code = 1;
    string message = 2;
  }
  
  oneof event {
    TypingIndicator typing = 1; // Индикатор набора текста/записи голоса.
    Message new_message = 2;    // Новое пришедшее сообщение.
    Error error = 3;            // Ошибка стрима или обработки.
  }
}