syntax = "proto3";

package mentor.types.billing;

import "mentor/types/common.proto";
import "google/protobuf/timestamp.proto";

// --- Enums ---

// Plan Status
enum PricingPlanStatus {
  PRICING_PLAN_STATUS_UNSPECIFIED = 0;
  PRICING_PLAN_STATUS_DRAFT = 1;
  PRICING_PLAN_STATUS_ACTIVE = 2;
  PRICING_PLAN_STATUS_ARCHIVED = 3;
}

// Plan Type
enum PricingPlanType {
  PRICING_PLAN_TYPE_UNSPECIFIED = 0;
  PRICING_PLAN_TYPE_SUBSCRIPTION = 1; // Default content subscription
  PRICING_PLAN_TYPE_CREATOR_ACCESS = 2; // Paid access to create bots
}

// Subscription Status
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0;
  SUBSCRIPTION_STATUS_ACTIVE = 1;
  SUBSCRIPTION_STATUS_CANCELLED = 2;
  SUBSCRIPTION_STATUS_EXPIRED = 3;
  SUBSCRIPTION_STATUS_SUSPENDED = 4; // Payment failed
}

// Payment Type
enum PaymentType {
  PAYMENT_TYPE_UNSPECIFIED = 0;
  PAYMENT_TYPE_PREPAID = 1; // One-time payment
  PAYMENT_TYPE_RECURRING = 2; // Monthly subscription
}

// --- Models ---

// Pricing Plan (Subscription Plan)
message PricingPlan {
  uint32 id = 1;

  // Creator User ID or Company ID (u32, assuming users are u32? Wait, User ID is UUID string)
  // The spec says "creatorId (u32)". Let's stick to u32 for now, maybe creator is a different entity ID space?
  // Actually, User ID in identity.proto is string UUID. But PricingPlan spec says u32.
  // I will use string to be safe if it refers to User.
  string creator_id = 2;

  PricingPlanStatus status = 3;
  PricingPlanType type = 4;

  // Price configuration
  string price = 5; // "10.00"
  uint32 currency_id = 6;
  
  // Duration in months
  uint32 duration_months = 7;

  // Feature flags / constraints
  map<string, string> features = 8;
  
  // Quota Rules included in this plan
  repeated QuotaRule quota_rules = 9;

  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

// Rule for calculating quota limits
message QuotaRule {
  uint32 id = 1;
  uint32 plan_id = 2;

  // Quota Template Parameters
  QuotaTemplate quota_template = 3;

  // List of Bot IDs included in this quota group
  repeated uint32 included_bot_ids = 4;
}

// Quota Template Configuration
message QuotaTemplate {
  // e.g. "MESSAGE", "CALL_MINUTES"
  string resource_type = 1;

  // Limit per cycle (e.g. 50)
  int32 limit_per_cycle = 2;

  // Cycle duration (e.g. "1d", "1m")
  string cycle_duration_iso = 3; 

  // Rollover limit (cumulative)
  int32 rollover_limit = 4;
}

// User Subscription
message Subscription {
  string id = 1; // UUID
  string user_id = 2; // UUID
  
  // Plan details snapshot or reference
  uint32 plan_id = 3;
  PricingPlan plan_snapshot = 4; // Optional full details

  SubscriptionStatus status = 5;
  PaymentType payment_type = 6;

  google.protobuf.Timestamp starts_at = 7;
  google.protobuf.Timestamp expires_at = 8;

  bool auto_renew = 9;
  string total_price = 10; // Total contract price
}

// Dashboard Data
message SubscriptionDashboardData {
  string total_monthly_payment = 1; // "150.00"
  int32 call_balance_seconds = 2;
  repeated Subscription subscriptions = 3;
}

// Transaction History Item
message Transaction {
  string id = 1;
  string user_id = 2;
  
  string description = 3;
  string amount = 4; // "-10.00"
  uint32 currency_id = 5;

  enum Status {
    STATUS_UNSPECIFIED = 0;
    STATUS_PENDING = 1;
    STATUS_SUCCESS = 2;
    STATUS_FAILED = 3;
  }
  Status status = 6;

  google.protobuf.Timestamp created_at = 7;

  string invoice_id = 8;
}
