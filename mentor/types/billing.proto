syntax = "proto3";

package mentor.types.billing;

import "mentor/types/common.proto";
import "google/protobuf/timestamp.proto";

// --- Перечисления (Enums) ---

// Статус тарифного плана.
enum PricingPlanStatus {
  PRICING_PLAN_STATUS_UNSPECIFIED = 0; // Не указан
  PRICING_PLAN_STATUS_DRAFT = 1;       // Черновик (виден только автору)
  PRICING_PLAN_STATUS_ACTIVE = 2;      // Активен (виден всем)
  PRICING_PLAN_STATUS_ARCHIVED = 3;    // В архиве (доступен только старым подписчикам)
}

// Тип тарифного плана.
enum PricingPlanType {
  PRICING_PLAN_TYPE_UNSPECIFIED = 0;     // Не указан
  PRICING_PLAN_TYPE_SUBSCRIPTION = 1;    // Подписка на контент (ботов)
  PRICING_PLAN_TYPE_CREATOR_ACCESS = 2;  // Платная услуга для создателей
}

// Статус подписки.
enum SubscriptionStatus {
  SUBSCRIPTION_STATUS_UNSPECIFIED = 0; // Не указан
  SUBSCRIPTION_STATUS_ACTIVE = 1;      // Активна
  SUBSCRIPTION_STATUS_CANCELLED = 2;   // Отменена (действует до конца периода)
  SUBSCRIPTION_STATUS_EXPIRED = 3;     // Истекла
  SUBSCRIPTION_STATUS_SUSPENDED = 4;   // Приостановлена (ошибка оплаты)
}

// Тип оплаты.
enum PaymentType {
  PAYMENT_TYPE_UNSPECIFIED = 0; // Не указан
  PAYMENT_TYPE_PREPAID = 1;     // Разовая оплата за весь период
  PAYMENT_TYPE_RECURRING = 2;   // Рекуррентная подписка (ежемесячно)
}

// Статус транзакции.
enum TransactionStatus {
  TRANSACTION_STATUS_UNSPECIFIED = 0; // Не указан
  TRANSACTION_STATUS_PENDING = 1;     // В ожидании
  TRANSACTION_STATUS_COMPLETED = 2;   // Завершена успешно
  TRANSACTION_STATUS_FAILED = 3;      // Ошибка
}

// Тип транзакции.
enum TransactionType {
  TRANSACTION_TYPE_UNSPECIFIED = 0; // Не указан
  TRANSACTION_TYPE_DEPOSIT = 1;     // Пополнение
  TRANSACTION_TYPE_PURCHASE = 2;    // Покупка
  TRANSACTION_TYPE_REFUND = 3;      // Возврат
  TRANSACTION_TYPE_REWARD = 4;      // Награда
}

// Направление транзакции.
enum TransactionDirection {
  TRANSACTION_DIRECTION_UNSPECIFIED = 0; // Не указано
  TRANSACTION_DIRECTION_INCOMING = 1;    // Входящая (+)
  TRANSACTION_DIRECTION_OUTGOING = 2;    // Исходящая (-)
}

// --- Модели ---

// Тарифный План.
message PricingPlan {
  uint32 id = 1;

  // ID создателя (Пользователь или Компания).
  uint32 creator_id = 2;

  PricingPlanStatus status = 3;
  PricingPlanType type = 4;

  // Цена ("10.00").
  string price = 5;
  uint32 currency_id = 6;
  
  // Длительность в месяцах.
  uint32 duration_months = 7;

  // Дополнительные параметры (JSON map).
  map<string, string> features = 8;
  
  // Правила квот, включенные в этот план.
  repeated QuotaRule quota_rules = 9;

  google.protobuf.Timestamp created_at = 10;
  google.protobuf.Timestamp updated_at = 11;
}

// Правило для расчета лимитов (Квота).
message QuotaRule {
  uint32 id = 1;
  uint32 plan_id = 2;

  // Шаблон настроек лимита.
  QuotaTemplate quota_template = 3;

  // Список ID ботов, входящих в эту группу.
  repeated uint32 included_bot_ids = 4;
}

// Шаблон настроек квоты.
message QuotaTemplate {
  // Тип ресурса (MESSAGE, CALL_MINUTES).
  string resource_type = 1;

  // Лимит на один цикл.
  int32 limit_per_cycle = 2;

  // Длительность цикла (ISO 8601 duration, например "P1D").
  string cycle_duration = 3; 

  // Лимит накопления остатков.
  int32 rollover_limit = 4;
}

// Подписка пользователя.
message Subscription {
  string id = 1; // UUID
  string user_id = 2; // UUID
  
  // Ссылка на план.
  uint32 plan_id = 3;
  
  // Краткая копия плана на момент покупки (историчность).
  PricingPlan plan_snapshot = 4; 

  // Опционально: Конкретный бот, на которого куплена подписка (если план Individual).
  string bot_id = 11; // ID бота (если известно, что это один бот). Хотя bot_id у нас u32.
  // Исправление: Bot ID у нас u32. Но в spec написано uuid. 
  // Мы договорились использовать u32 для Bot ID.
  uint32 bot_id_u32 = 12; 

  SubscriptionStatus status = 5;
  PaymentType payment_type = 6;

  google.protobuf.Timestamp starts_at = 7;
  google.protobuf.Timestamp expires_at = 8;

  bool auto_renew = 9;
  string total_price = 10; // Общая сумма контракта.
}

// Агрегированные данные для дашборда подписок.
message SubscriptionDashboardData {
  string total_monthly_payment = 1; 
  int32 call_balance_seconds = 2;
  repeated Subscription subscriptions = 3;
}

// Финансовая транзакция.
message Transaction {
  string id = 1; // UUID
  string user_id = 2; // UUID
  
  TransactionType type = 3;
  TransactionStatus status = 4;
  
  string amount = 5; // Абсолютное значение ("10.50")
  uint32 currency_id = 6;
  
  TransactionDirection direction = 7;
  
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp completed_at = 9;

  // Ссылка на внешний объект (ID подписки и т.д.)
  string reference_id = 10;
  
  // ID во внешней платежной системе.
  string external_tx_id = 11;
}
