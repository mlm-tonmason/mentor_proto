syntax = "proto3";

package mentor.types.billing;

import "mentor/types/bot.proto";
import "mentor/types/common.proto";
import "mentor/types/identity.proto";
import "google/protobuf/timestamp.proto";


// --- Модели ---

// Тарифный план бота (публичная модель для отображения в каталоге).
message BotTariffPlan {
  // Идентификатор плана.
  message Id {
    uint32 plan_id = 1;
  }

  // Список тарифных планов.
  message List {
    repeated BotTariffPlan items = 1;
  }
  
  // Статус тарифного плана.
  message Status {
    enum Id {
      UNSPECIFIED = 0; // Не указан
      DRAFT = 1;       // Черновик (виден только автору)
      ACTIVE = 2;      // Активен (виден всем)
      ARCHIVED = 3;    // В архиве (доступен только старым подписчикам)
    }
  }

  // Метрики квоты (лимиты ресурсов).
  // Используется для описания того, что включает в себя конкретная группа квот.
  message QuotaMetrics {
    uint32 msg = 1;  // Количество текстовых сообщений.
    uint32 call = 2; // Количество секунд звонков.
  }

  uint32 plan_id = 1;   // Уникальный идентификатор тарифного плана.
  uint32 creator_id = 2; // Идентификатор создателя (дистрибьютора), создавшего план.
  Status.Id status = 3;   // Статус тарифного плана.

  // Карта распределения ботов по группам квот.
  // Ключ: ID бота (uint32).
  // Значение: ID квоты (uint32), к которой бот привязан.
  // Это позволяет понять, какие боты делят между собой общие ресурсы.
  map<uint32, uint32> bot_quota = 4; 

  // Описание самих квот.
  // Ключ: ID квоты (uint32), на который ссылается bot_quota.
  // Значение: Метрики (лимиты) этой квоты.
  map<uint32, QuotaMetrics> day_quota_metrics = 5; 

  mentor.types.Money month_price = 6; // Стоимость подписки за один месяц (в базовой валюте).
  uint32 duration_months = 7;         // Общая длительность подписки в месяцах (срок действия контракта).
}

// Подписка на бота (экземпляр плана).
message BotSubscription {
  message Id {
    uint32 id = 1; // Внутренний уникальный ID подписки в системе.
  }

  // Статус подписки.
  message Status {
    enum Id {
      UNSPECIFIED = 0; // Не указан
      ACTIVE = 1;      // Активна
      CANCELLED = 2;   // Отменена (действует до конца периода)
      EXPIRED = 3;     // Истекла
      SUSPENDED = 4;   // Приостановлена (ошибка оплаты)
    }
  }

  uint32 id = 1;      // Внутренний уникальный ID подписки в системе.
  uint32 nonce = 2;   // Порядковый номер подписки у дистрибьютора на данного создателя (для чеков/счетов).
  uint32 creator_id = 3; // Идентификатор создателя контента (на кого подписались).
  uint32 distributor_id = 4; // Идентификатор дистрибьютора, через которого прошла продажа (реферальная система).
  
  // Ссылка на тарифный план, по которому приобретена подписка.
  uint32 plan_id = 5;
  Status.Id status = 6;

  // Использованные ресурсы за текущий период (Usage tracking).
  message PeriodQuotaMetricsUsed {
    BotTariffPlan.QuotaMetrics metrics = 1; // Сколько уже потрачено ресурсов.
    mentor.types.DateRange period = 2; // Период действия квоты.
  }

  // Состояние расхода квот.
  // Ключ: ID квоты (uint32) из BotTariffPlan.quota_metrics.
  // Значение: Текущий прогресс использования и сроки периода.
  map<uint32, PeriodQuotaMetricsUsed> period_quota_metrics_used = 7; 

  // Временные метки времени жизни всей подписки.
  mentor.types.DateRange total_period = 8; // Общий срок действия подписки.
  
  // Дата следующего автоматического приобретения/продления (если контракт предполагает это).
  // Может отсутствовать, если это конец срока или автопродление невозможно.
  optional google.protobuf.Timestamp next_renewal_at = 9;
}

// Данные для дашборда подписок клиента.
// Агрегирует всю информацию о текущих подписках пользователя для отображения одним запросом.
message SubscriptionDashboardData {
  // Список профилей создателей (авторов), на которых есть активные или архивные подписки.
  // Используется для отображения аватарок и имен в списке подписок.
  repeated mentor.types.identity.PublicUserProfile creators = 1;

  // Список актуальных тарифных планов, связанных с подписками.
  // Необходим для отображения названий тарифов, лимитов и условий.
  repeated BotTariffPlan bot_tariff_plans = 2;

  // Список самих подписок пользователя.
  repeated BotSubscription bot_subscriptions = 3;

  // Список самих ботов, на которых есть подписки.
  repeated mentor.types.bot.Bot bots = 4;
}

// Финансовая транзакция.
message Transaction {
  message Id {
    uint32 id = 1; 
  }

  // Список транзакций (для возврата в API).
  message List {
    repeated Transaction items = 1;
  }
  
  // Статус транзакции.
  message Status {
    enum Id {
      UNSPECIFIED = 0; // Не указан
      PENDING = 1;     // В ожидании
      COMPLETED = 2;   // Завершена успешно
      FAILED = 3;      // Ошибка
    }
  }

  // Метаданные транзакции (детали продукта/услуги).
  message Metadata {
    // Детали транзакции для подписки на бота.
    message BotSubscriptionDetails {
      uint32 bot_subscription_id = 1; // ID приобретенной/продленной подписки.

      // Период, за который была оплата подписки (например, 01.01.2025 - 01.02.2025).
      mentor.types.DateRange subscription_period = 2;
    }
    
    // Детали транзакции (в зависимости от типа продукта).
    // Позволяет добавлять новые типы покупок без изменения основной структуры Transaction.
    oneof details {
      BotSubscriptionDetails bot_subscription = 1; // Покупка подписки на бота.
      // OtherProductDetails other_product = 2; // Будущие типы продуктов.
    }
  }

  uint32 id = 1; // Глобальный уникальный ID транзакции.
  uint32 distributor_id = 2; // ID пользователя (дистрибьютора), который совершил платеж.
  
  Status.Id status = 3; // Текущий статус транзакции (Pending, Completed, Failed).
  Metadata metadata = 4; // Метаданные транзакции (что именно куплено).

  // Сумма подписки в базовой валюте (обычно USD для отображения).
  // Используется для статистики и отчетности.
  mentor.types.Money amount_base = 5;
  
  // Сумма, фактически списанная в валюте оплаты (например, TON, USDT).
  // Точная сумма транзакции в блокчейне или платежной системе.
  mentor.types.Money amount_charged = 6;
  
  // Дата создания транзакции (UTC).
  google.protobuf.Timestamp created_at = 7;
}
