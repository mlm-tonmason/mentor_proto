# Процессы Чата (Chat Flows)

## 1. Обмен сообщениями
* **Структура сообщения**:
    * Сообщение может содержать текст и/или вложения (Аудио, Фото, Видео, Файл).
    * **Вложения**:
        * На клиенте отображается мета-информация (размер, длительность аудио, превью видео), а не "сырой" контент, если файл тяжелый.
        * **Аудио-сообщения**: Всегда отображаются вместе с текстовой транскрипцией (Speech-to-Text).
* **Ввод (Input)**:
    * Пользователь может отправить ЛИБО текст, ЛИБО голосовое сообщение (взаимоисключающие режимы ввода).
* **Режим ответа (Response Mode)**:
    * В настройках конкретного чата можно выбрать: отвечать текстом или голосом.
* **Отправка сообщения**:
    * Вход: `botId`, `content`, `sinkingMode`.
    * Логика:
        1. **Проверка Подписки и Квоты**:
            * Найти активную `Subscription` пользователя, покрывающую `botId`.
            * Внутри подписки найти `PricingPlan` и соответствующее `QuotaRule` для этого бота.
            * Найти текущую активную `Quota`, созданную по этому правилу.
            * Проверка: `available > 0`.
            * Действие: `reserved += 1` (блокировка слота).
        2. Загрузка вложений (если есть).
        3. Сбор контекста.
        4. Запрос к Provider API.
        5. При успехе/ошибке: `reserved -= 1`, `used += 1` (если успех).
        6. Сохранение истории.
* **Получение истории (`GetHistory`)**:
    * Пагинация сообщений в рамках `ChatThread`.
    * **Фильтр**: `onlyFavorites=true` (Показать только избранные сообщения внутри этого чата).
* **Избранные сообщения**:
    * `ToggleMessageFavorite(messageId)`: Добавить/Убрать.
    * `GetFavoriteMessages(botId, pagination)`: Получить список избранного для конкретного бота (сквозной поиск по всем чатам бота).

## 2. Управление списком чатов (Sidebar UI)
* **Список**: Иерархический список "Бот -> Его диалоги".
* **Пагинация**: Подгрузка списка диалогов `GetBotChats(botId, page, filter=ARCHIVED|ACTIVE)`.
* **Закрепление (Pinning)**:
    * `PinChat(threadId)`: Закрепить диалог. Максимум 5 (LIFO или ручная сортировка).
    * `UnpinChat(threadId)`: Открепить.
    * `ReorderPinnedChats(list threadIds)`: Изменить порядок закрепленных чатов (контроль очередности).

## 3. Состояния Чата (Chat States)
* **Технология**: gRPC Streaming (Server-to-Client).
* **События (Bot Only)**:
    * `bot_typing`: Бот генерирует текстовый ответ.
    * `bot_recording`: Бот генерирует/записывает голосовой ответ.
* **Описание**: Клиент подписывается на стрим событий. События от пользователя (я печатаю) игнорируются на данном этапе (MVP).
* **Цель**: Обеспечить отзывчивость интерфейса при ожидании ответа от LLM.

## 4. Управление данными чата
* **Архивация (Archive)**:
    * `ArchiveChat(threadId)`: Переместить конкретный диалог в архив.
    * `ArchiveAllBotChats(botId)`: Переместить ВСЕ диалоги с данным аватаром в архив.
    * `UnarchiveChat(threadId)`: Вернуть из архива.
    * `UnarchiveAllBotChats(botId)`: Вернуть все диалоги аватара.
    * *Влияние*: Архивированные чаты скрываются из основного списка "Recent", но доступны через фильтр "Archived".
* **Очистка чата**:
    * Действие: Удаляет `Message`, `DialogueSummary`, `CallTranscript` для данного чата.
    * Результат: Полная очистка истории переписки.

## 5. Управление сессиями (Dialogue Session Manager)
* **Автоматическое управление**:
    * Отслеживание `lastUserActivityAt`.
    * Если активность > 2 часов назад -> закрытие текущей `DialogueSession`, генерация Summary, создание новой сессии.
* **Sinking Mode**:
    * Переключатель в UI "думать дольше".
    * Сохраняется как настройка, передается в каждом запросе к Provider API.

## 6. Звонки (Calls Realtime)

### Управление звонком
* **Start Call**:
    * Проверка квоты минут (`CallMinutesQuota`).
    * Выбор `voiceId` (пользователем или default).
    * Создание `CallSession`.
    * Соединение с Provider (Streaming API).
* **End Call**:
    * Завершение сессии.
    * Получение и сохранение `CallTranscript` (транскрипт).
    * Обновление квоты минут.
* **Интеграция с чатом**:
    * Звонок привязан к текущей `DialogueSession`.
    * После звонка пользователь может продолжить общение текстом в том же контексте.

## 7. Уведомления (Notifications)
* **In-app / Browser Push**:
    * Уведомление "Вам пришел ответ", если пользователь покинул вкладку/экран чата во время генерации ответа.
