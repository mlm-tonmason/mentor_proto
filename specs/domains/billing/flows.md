# Процессы Биллинга (Billing Flows)

## 1. Покупка (Billing Flow)
Процесс покупки тарифа:
1. Пользователь нажимает "Купить" (Subscribe).
2. Mentor API получает запрос.
3. Бэкенд инициирует транзакцию во **внешнем сервисе** (Network).
4. Если успех -> Mentor API активирует `Subscription`.
5. Если отказ (недостаточно средств) -> Возврат ошибки пользователю.
* *Важно*: Пользователь не взаимодействует с Network напрямую, всё через Mentor API.

## 2. Управление подписками (Profile Settings)
* **Локация**: Раздел "Настройки" -> "Подписки".
* **Функции**:
    * Просмотр активных подписок и их статусов.
    * Переключатель `AutoRenew` (Автопродление).
    * Отображение остатков квот (см. раздел 3).

## 3. Просмотр Квот (Quota Dashboard)
Пользователь видит детальное состояние своих лимитов:
* **Индикаторы**:
    * `Available`: Доступно сейчас (например, 12).
    * `Used`: Уже потрачено (например, 35).
    * `Reserved`: В обработке (например, 1 - "бот думает").
    * `Total`: Всего в пакете (например, 50).
* **Временная шкала**:
    * `Current Cycle`: "Сегодня: 00:00 - 23:59".
    * `Next Update`: "Обновится через 4 часа".
    * `Global Validity`: "Пакет действует до 15 фев. 2026".
* **Логика сгорания (Burn logic)**:
    * Четкое предупреждение: "Неиспользованные 12 сообщений сгорят через 4 часа".
* **Sharing (Совместное использование)**:
    * Отображение списка Аватаров, которые "питаются" из этой квоты (например: "Общий лимит на 3-х ботов").

### 4. Административное Ценообразование (Admin)

### 4.1 Конструктор Тарифов (Admin UI)
Процесс создания тарифного плана (Иерархический):
1.  **Подготовка Ботов**: Сначала создаются боты (`CreateBot`), которые будут включены в пакет.
2.  **Создание Плана (`CreatePricingPlan`)**:
    *   Устанавливается Название, Цена, Валюта, Длительность.
3.  **Настройка Квотируемых Групп (`QuotaRule`)**:
    *   Внутри плана создаются правила (группы).
    *   **Типы групп**:
        *   **Shared Pool (Общий котел)**: "50 сообщений в сутки на Группу А".
        *   **Individual (Персональный)**: "1 сообщение в сутки на Бота Б".
    *   **Привязка**: Администратор выбирает ботов и добавляет их в конкретную группу.
4.  **Пример**:
    *   План "Super Pack".
    *   Группа 1 (Shared): Лимит 100 msg/day -> Bots [Alpha, Beta, Gamma].
    *   Группа 2 (Individual): Лимит 5 msg/day -> Bot [Omega].
    *   *Результат*: Пользователь тратит общий лимит на первых трех, но четвертый ограничен жестко.

### 4.2 Жизненный цикл Тарифа (Lifecycle)
* **Черновик (DRAFT)**: Автор создает и настраивает план. Никто не видит.
* **Публикация (ACTIVE)**: План появляется в каталоге и на странице бота. Доступен для покупки всем.
* **Архивация (ARCHIVED)**:
    * Автор скрывает план (например, старая цена).
    * **Для новых пользователей**: План невидим и недоступен.
    * **Для действующих подписчиков**: План остается видимым в "Моих Подписках".
    * **Продление**: Действующий подписчик МОЖЕТ продлить этот тариф или купить его заново (Legacy Access), пока автор не удалит его окончательно (Hard Delete).
