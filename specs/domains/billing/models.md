# Домен Биллинга (Billing Domain)

## Модели

### PricingPlan (Тарифный План)
Тарифный план подписки на Аватара (или группу).
* **id** (u32): ID плана.
* **creatorId** (u32): Автор пакета (Пользователь или Компания).
* **status** (enum): Жизненный цикл плана.
    * `DRAFT`: Черновик (виден только автору).
    * `ACTIVE`: Активен (виден в каталоге, доступен всем).
    * `ARCHIVED`: В архиве (скрыт из каталога).
        * *Важно*: Остается доступным для продления/покупки тем пользователям, у которых УЖЕ была на него подписка (Legacy support).
* **price** (string): Итоговая цена ("100.00").
* **currencyId** (u32): Валюта цены.
* **type** (enum):
    * `SUBSCRIPTION` (Default): Подписка на контент (ботов).
    * `CREATOR_ACCESS`: Платная услуга для создателей (право создать X ботов и т.д.).
* **features** (map<string, string>): Доп. параметры (для CREATOR_ACCESS).
    * `MAX_BOTS`: "5".
    * `NO_WATERMARK`: "true".

### QuotaRule (Квотируемая Группа)
Правило, определяющее лимит для группы ботов внутри плана.
* **id** (u32): ID правила.
* **planId** (u32): Ссылка на план.
* **quotaTemplate**: Параметры лимита (50 сообщений в сутки).
    * `limitPerCycle`: Количество.
    * `cycleDuration`: Период.
* **includedBotIds** (list u32): Список ботов, входящих в эту группу.
    * Если в списке > 1 бота -> они делят общий пул (Shared Quota).
    * Если в списке 1 бот -> у него персональный лимит.

### Subscription (Подписка)
Активная подписка пользователя.
* **id** (uuid): ID подписки.
* **userId** (uuid): Пользователь.
* **botId** (uuid): Аватар (опционально, если подписка на конкретного).
* **planId** (uuid): Купленный тарифный план `PricingPlan`.
* **status** (enum): ACTIVE (активна), CANCELLED (дорабатывает период), EXPIRED (истекла).
* **paymentType** (enum):
    * `PREPAID`: Разовая оплата за весь период (например, за год вперед).
    * `RECURRING`: Ежемесячное списание (в течение срока плана).
* **startsAt** (timestamp): Время начала.
* **expiresAt** (timestamp): Окончание текущего оплаченного периода.
* **autoRenew** (boolean): Автопродление (переключатель в UI).
* **totalPrice** (decimal): Общая сумма контракта.

### SubscriptionDashboardData
Агрегированные данные для страницы "Мои подписки".
* **totalMonthlyPayment** (decimal): "Итоговая ежемесячная подписка" (сумма рекуррентных платежей).
* **callBalanceSeconds** (int): Общий баланс минут звонков (суммарно по всем квотам).
* **subscriptions** (list Subscription): Список подписок с деталями.

### Quota (Лимит / Квота)
Сущность, управляющая ограничениями потребления ресурсов (сообщения, минуты).
* **id** (u32): Уникальный ID квоты.
* **userId** (u32): Владелец квоты.
* **type** (enum): MESSAGE, CALL_MINUTES.
* **validity**: Глобальный период действия квоты (например, подписка на месяц).
    * `startsAt` (timestamp): Начало действия права на квоту.
    * `expiresAt` (timestamp): Окончание действия права.
* **cycle**: Настройки цикла обновления (например, ежедневный сброс).
    * `duration` (duration): Длительность одного периода (например, 1 день).
    * `limitPerCycle` (int): Сколько доступно в один период (например, 50).
    * `rolloverLimit` (int): Максимальное накопление остатков (если 0, то сгорают; сейчас принят вариант B - накопление).
* **state**: Текущее состояние (в рамках текущего цикла).
    * `currentCycleStart` (timestamp): Начало текущего периода (сегодня 00:00).
    * `currentCycleEnd` (timestamp): Конец текущего периода (сегодня 23:59).
    * `used` (int): Использовано успешно.
    * `reserved` (int): Забронировано (в процессе генерации/звонка).
        * *Важно*: `available = limitPerCycle + rollover - used - reserved`.
* **state**: Текущее состояние (в рамках текущего цикла).
    * `currentCycleStart` (timestamp): Начало текущего периода (сегодня 00:00).
    * `currentCycleEnd` (timestamp): Конец текущего периода (сегодня 23:59).
    * `used` (int): Использовано успешно.
    * `reserved` (int): Забронировано (в процессе генерации/звонка).
        * *Важно*: `available = limitPerCycle - used - reserved`.
* **features**:
    * **Burn logic**: Неиспользованные за цикл единицы сгорают.
    * **Sharing**: Несколько ботов могут ссылаться на одну `QuotaId` и потреблять общий пул.

### BotQuotaBinding
Связь бота с квотой. Определяет, какую квоту тратит использование данного бота.
* **botId** (uuid): Бот.
* **quotaId** (uuid): Квота.
    * Если несколько ботов указывают на один `quotaId`, они тратят "общий пакет".
